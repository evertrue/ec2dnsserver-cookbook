<% require 'ipaddr' -%>
$TTL <%= @default_ttl %>
$ORIGIN <%= @apex %>.
@ <%= @default_ttl %> IN SOA <%= @source_host %>.<%= @suffix %>. <%= @contact_email %>. (
  <%= @serial_number %>
  <%= @refresh_time %>
  <%= @retry_time %>
  <%= @expire_time %>
  <%= @min_ttl %>
)
<%
  if ! Chef::Recipe::Ec2DnsServer.valid_hostname?(node.name)
    raise "My own hostname #{node.name} is invalid"
  end
-%>

 NS <%= node.name %>.<%= @suffix %>.

<% if @ptr -%>
<%= IPAddr.new(node['ipaddress']).reverse.sub(/\.?#{Regexp.escape(@apex)}$/,'') %> IN PTR <%= node.name %>.<%= @suffix %>.

<% @hosts.each do |rr,val| -%>
<% if rr != node.name -%>
<%
  if ! Chef::Recipe::Ec2DnsServer.valid_hostname?(rr)
    raise "Invalid hostname #{rr}"
  end
-%>
<%= IPAddr.new(val).reverse.sub(/\.?#{Regexp.escape(@apex)}$/,'') %> IN PTR <%= rr %>.<%= @suffix %>.
<% end # if rr != node.name -%>
<% end # @hosts.each do |rr,val| -%>
<% else -%>

<%= node.name %> IN A <%= node['ipaddress'] %>

<% @hosts.each do |rr,val| -%>
<% if rr != node.name -%>
<%
  if ! Chef::Recipe::Ec2DnsServer.valid_hostname?(rr)
    raise "Invalid hostname #{rr}"
  end
-%>
<%= rr %> IN A <%= val %>
<% end -%>
<% end -%>
<% end -%>
